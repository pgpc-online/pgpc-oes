{% extends "adminbase.html" %}
{% block content %}

<style>
/* ------------------- TITLE -------------------- */
.page-title {
    font-size: 26px;
    font-weight: 700;
    color: #1a237e;
    margin-bottom: 20px;
    font-family: 'Inter', sans-serif;
}

/* ------------------- SEARCH BAR -------------------- */
.search-bar {
    margin-bottom: 18px;
    display: flex;
    justify-content: flex-start;
}

.search-input {
    width: 260px;
    padding: 10px 14px;
    border: 1px solid #cfd3e0;
    border-radius: 8px;
    font-size: 14px;
}

/* ------------------- TABLE -------------------- */
.table-wrapper {
    background: #fff;
    padding: 22px;
    border-radius: 16px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.07);
}

table {
    width: 100%;
    border-collapse: collapse;
}

thead {
    background: #1a237e;
    color: white;
}

th, td {
    padding: 12px;
    font-size: 14px;
    border-bottom: 1px solid #eee;
}

/* ------------------- BADGES -------------------- */
.badge {
    padding: 4px 10px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
    color: white;
}

.badge-gray   { background: #9e9e9e; }
.badge-blue   { background: #1976d2; }
.badge-green  { background: #2e7d32; }
.badge-orange { background: #ef6c00; }

/* ------------------- ACTION BUTTONS -------------------- */
.action-btn {
    padding: 6px 12px;
    background: #1a237e;
    color: white;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    border: none;
    margin-right: 4px;
}

.action-btn:hover {
    background: #0c1657;
}

/* ------------------- MODAL -------------------- */
.modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.45);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 25px;
    width: 380px;
    border-radius: 14px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}

.modal-content h3 {
    margin-bottom: 14px;
    font-size: 20px;
    color: #1a237e;
}

/* modal form */
.modal-content input,
.modal-content textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #cfd3e0;
    border-radius: 8px;
    margin-bottom: 12px;
    font-size: 14px;
}

.modal-content button {
    margin-top: 10px;
    padding: 10px 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

.btn-primary {
    background:#1a237e;
    color:white;
}

.btn-secondary {
    background:#9e9e9e;
    color:white;
}
/* KEBAB MENU */
.action-menu {
    position: relative;
}

.menu-btn {
    background: none;
    border: none;
    font-size: 20px;
    padding: 6px 10px;
    cursor: pointer;
}

.menu-dropdown {
    display: none;
    position: absolute;
    right: 0;
    top: 30px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    min-width: 160px;
    z-index: 99;
}

.menu-dropdown button {
    width: 100%;
    padding: 10px 14px;
    text-align: left;
    background: none;
    border: none;
    font-size: 14px;
    cursor: pointer;
}

.menu-dropdown button:hover {
    background: #f5f5f5;
}
</style>

<h2 class="page-title">Exam Schedule</h2>

<!-- ------------------- SEARCH -------------------- -->
<div class="search-bar">
    <input type="text" id="searchInput" class="search-input"
           placeholder="Search by name, app ID, or course...">
</div>

<!-- ------------------- TABLE -------------------- -->
<div class="table-wrapper">
<table id="scheduleTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>App ID</th>
            <th>Program</th>
            <th>Date</th>
            <th>Time</th>
            <th>Room</th>
            <th>Status</th>
            <th style="width: 220px;">Actions</th>
        </tr>
    </thead>

    <tbody>
        {% for s in schedules %}
        <tr>
            <td>{{ s.firstName }} {{ s.lastName }}</td>
            <td>{{ s.app_id }}</td>
            <td>{{ s.program }}</td>
            <td>{{ s.exam_date or '-' }}</td>
            <td>{{ s.exam_time or '-' }}</td>
            <td>{{ s.exam_room or '-' }}</td>

            <td>
                {% if s.exam_status == "set" %}
                    <span class="badge badge-blue">Set</span>
                {% elif s.exam_status == "exam_taken" %}
                    <span class="badge badge-green">Taken</span>
                {% elif s.exam_status == "retake" %}
                    <span class="badge badge-orange">Retake</span>
                {% else %}
                    <span class="badge badge-gray">Not Set</span>
                {% endif %}
            </td>

            <td>

    <!-- SET / EDIT BUTTON -->
    <button class="action-btn"
            onclick="openScheduleModal('{{ s.app_id }}',
                                       '{{ s.exam_date }}',
                                       '{{ s.exam_time }}',
                                       '{{ s.exam_room }}',
                                       `{{ s.notes|escape }}`)">
        Set / Edit
    </button>

    <!-- KEBAB MENU -->
    <div class="action-menu" style="display:inline-block; position:relative;">
        <button class="menu-btn">â‹®</button>

        <div class="menu-dropdown">

            <!-- Mark Taken -->
            <form method="POST" 
                  action="/admin/mark-exam-taken/{{ s.app_id }}"
                  onsubmit="return confirm('Mark exam as TAKEN?');">
                <button type="submit">Mark as Taken</button>
            </form>

            <!-- Retake -->
            <form method="POST" 
                  action="/admin/mark-retake/{{ s.app_id }}"
                  onsubmit="return confirm('Mark as RETAKE?');">
                <button type="submit">Mark as Retake</button>
            </form>

            <!-- DELETE SCHEDULE -->
            <form method="POST" 
                  action="/admin/api/delete-schedule/{{ s.app_id }}"
                  onsubmit="return confirm('DELETE this exam schedule?');">
                <button type="submit">Delete Schedule</button>
            </form>

        </div>
    </div>
</td>

        </tr>
        {% endfor %}
    </tbody>

</table>
</div>

<!-- ------------------- MODAL -------------------- -->
<div class="modal" id="scheduleModal">
    <div class="modal-content">
        <h3>Edit Exam Schedule</h3>

        <form method="POST" id="modalForm">
            <input type="date" name="exam_date" id="modal_date">
            <input type="time" name="exam_time" id="modal_time">
            <input type="text" name="exam_room" id="modal_room" placeholder="Room">
            <textarea name="notes" id="modal_notes" placeholder="Notes..."></textarea>

            <button type="submit" class="btn-primary">Save</button>
            <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
        </form>
    </div>
</div>

<script>
/* ------------------- LIVE SEARCH -------------------- */
document.getElementById("searchInput").addEventListener("keyup", function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll("#scheduleTable tbody tr");

    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(filter) ? "" : "none";
    });
});

/* ------------------- MODAL FUNCTIONS -------------------- */
function openScheduleModal(app_id, date, time, room, notes) {
    document.getElementById("modalForm").action = "/admin/set-schedule/" + app_id;

    document.getElementById("modal_date").value = date || "";
    document.getElementById("modal_time").value = time || "";
    document.getElementById("modal_room").value = room || "";
    document.getElementById("modal_notes").value = notes || "";

    document.getElementById("scheduleModal").style.display = "flex";
}

function closeModal() {
    document.getElementById("scheduleModal").style.display = "none";
}

window.onclick = function(event) {
    const modal = document.getElementById("scheduleModal");
    if (event.target === modal) {
        closeModal();
    }
};
document.addEventListener("click", function (e) {

    // Close all menus
    document.querySelectorAll(".menu-dropdown").forEach(menu => {
        menu.style.display = "none";
    });

    // Open clicked menu
    if (e.target.classList.contains("menu-btn")) {
        const dropdown = e.target.nextElementSibling;
        dropdown.style.display = "block";
        e.stopPropagation();
    }
});
</script>

{% endblock %}
